# 命題4.4の証明（ドラフト）

## 資料準拠
- 命題4.4は「任意の初期状態と任意のお題に対し、スワップ回数が5回以下で済むような到達点が必ず存在する」という主張である（意味論4.4）。

## 未整備
- チェーンスワップ／独立スワップの定義は意味論本文に未記載。
- 「任意の初期状態」に対する全称量化を満たす理論的証明は未完成。
- 4.4を保証するための鍵補題（後述の補題L）が未証明。

## 提案/ドラフト
以下は4.4の**証明に向けた具体的枠組み**と、現段階で確定できる補題である。

### 0. 記法
- 位置集合を `P = {p1..p9}`、カード集合（=辺）を `E = {e1..e9}` とする。
- 初期配置は全単射 `f0: P -> E` で表す（位置にあるカードID）。
- お題は `t: P -> V`（Vは6マーク）で表す。
- 各カード `e` は端点マーク `α(e), β(e)` を持つ。

### 1. スワップ回数とサイクル分解
**補題1（標準）**  
置換 `π` を2点互換（スワップ）で表す最小回数は  
`9 - (#cycles(π))` である。

**証明（スケッチ）**  
`π` を互いに素な巡回置換の積に分解すると、長さ `k` の巡回は `k-1` 回のスワップで実現できる。  
全サイクルの総和より `Σ(k-1) = 9 - (#cycles)`。最小性は巡回ごとの下界で従う。

### 2. 命題4.4の言い換え
4.4は以下と同値になる。

**命題4.4'**  
任意の初期配置 `f0` と任意のお題 `t` に対し、  
`f1 ∈ S_t`（お題を満たす配置の集合）で  
`#cycles(f0^{-1} ∘ f1) ≥ 4` を満たすものが存在する。

### 3. チェーンスワップ長4 ⇒ 固定点の存在
**補題2（確定）**  
「チェーンスワップ長4（=5-cycle）」を含み、総スワップ回数が5以下である場合、固定点は必ず存在する。

**理由**  
5-cycle は5枚を動かす。残り4枚は動かないか、独立スワップで動くとしても最大2枚。  
よって少なくとも2枚は不動（固定点）となる。

**補題3（確定）**  
スワップ回数が5以下なら、固定点または2-cycleが必ず存在する。

**理由**  
スワップ回数 ≤5 ⇔ `#cycles ≥ 4`。  
9枚でサイクル数が4以上になるためには、長さ1または2のサイクルが必ず現れる。

### 4. 三角柱の辺分解（e1..e9）
三角柱の辺は以下で分割できる。

- 三角形A: `{e1, e2, e8}`（マル・クッキー・サクラ）
- 三角形B: `{e4, e6, e9}`（ライム・花々・ブロッコ）
- クロス辺: `{e3, e5, e7}`

お題 `t` のマーク出現数を `c(v)` とする。  
`cA = c(マル)+c(クッキー)+c(サクラ)`, `cB = 9 - cA`。  
このとき、A側に向くクロス辺数は `kA = cA - 3`（B側は `kB = 3 - kA`）。

### 5. 主要補題L（要証明）
**補題L（要証明）**  
`cA ∈ {3,4,5,6}` の各場合について、A側に割り当てられる `cA` 枚のカード配置は、  
`#cycles(πA) ≥ floor(cA/2)` を満たすように構成できる。  
同様にB側も `#cycles(πB) ≥ floor(cB/2)` を満たすように構成できる。

**この補題が示せれば**  
`floor(cA/2) + floor(cB/2) ≥ 4` が成立するため、4.4'（=4.4）が従う。

### 6. 補題Lの構成方針（ドラフト）
- A側は `A三角形3辺 + A向きクロス辺(kA本)` の計 `cA` 辺。  
- これらは「Aマーク3種」に対する割当問題であり、各マークは最大2回要求される。  
- **狙い**: 同一マーク2個の位置で2-cycleを作り、残りで固定点を作る。
- 具体化は `cA=3,4,5,6` の4ケースで個別に構成する。

### 6.1 ケース構成（cA=3,4,5,6）
以下は**具体構成のドラフト**であり、閉路数の下界を与えるための「閉路の閉じ方」に未整備部分が残る。

#### ケース cA=3（kA=0）
- A側カードは `{e1,e2,e8}` のみ（クロス辺は全てB向き）。
- A側の要求は `1,1,1` または `2,1,0` のいずれか（各マーク最大2）。
- **主張（ドラフト）**: A側の置換は3枚に関する置換であり、`#cycles(πA) ≥ 1 = floor(3/2)` は自動的に満たされる。
- **未整備**: 「A側カードの割当は常に可能」という事実は既知だが、厳密な割当証明は別途必要。

#### ケース cA=4（kA=1）
- A側カードは `{e1,e2,e8}` と、クロス辺のうち1本。
- A側の要求は `2,1,1` または `2,2,0`。
- **構成案**  
  1. 出現数2のマークを `v` とする。`v` に対応するクロス辺（`v=マル: e3`, `v=サクラ: e5`, `v=クッキー: e7`）をA向きに選ぶ。  
  2. `v` の2位置には「クロス辺 + A三角形辺のいずれか1本」を割り当てる。  
  3. 残り2位置には A三角形辺の残り2本を割り当てる。
- **狙い**: 2位置のペアを閉じた2-cycleまたは固定点として作り、残り2位置でも1cycleを作ることで `#cycles(πA) ≥ 2` を得る。
- **未整備（要証明）**:  
  「ペア内で割当を閉じる（カードの現在位置がペア内に収まる）ように常に選べる」こと。

#### ケース cA=5（kA=2）
- A側カードは `{e1,e2,e8}` と、クロス辺2本。
- A側の要求は `2,2,1` のみ。
- **構成案**  
  1. 出現数2のマーク2種を `v,w` とする。対応するクロス辺2本をA向きに選ぶ。  
  2. `v` と `w` の各2位置に「対応クロス辺 + A三角形辺の1本」を割り当てる。  
  3. 残りの1位置には A三角形辺の残り1本を割り当てる。
- **狙い**: 2位置ペアを2つ作り、少なくとも `#cycles(πA) ≥ 2` を確保する。
- **未整備（要証明）**:  
  2つのペアが同時に閉じる（割当カードが各ペア内に留まる）ように選べること。

#### ケース cA=6（kA=3）
- A側カードは `{e1,e2,e8,e3,e5,e7}`（クロス辺全てA向き）。
- A側の要求は `2,2,2` のみ。
- **構成案**  
  1. 各マーク `v∈{マル,クッキー,サクラ}` に対応するクロス辺をその2位置のどちらかへ割当。  
  2. 残りの各2位置に A三角形辺 `e1,e2,e8` を1本ずつ割当。  
  3. 3つのペアをそれぞれ閉じた2-cycleまたは固定点として構成。
- **狙い**: 3ペアが閉じれば `#cycles(πA) ≥ 3` が得られる。
- **未整備（要証明）**:  
  3ペアを同時に閉じる割当（カードの現在位置が各ペア内に留まる）が常に選べること。

### 6.2 主要ギャップの明文化
- 上記4ケースの核心は「**ペア内で閉じる割当を常に選べる**」という点である。  
- これは「現在位置→目標位置」の置換において、  
  **サイズ2の閉路を十分数作るサイクルカバー**が必ず存在することを主張している。  
- このギャップを埋めるには、  
  (a) グラフの構造的性質からの一般証明、または  
  (b) 有限ケースの全件検証  
  のいずれかが必要となる。

### 6.3 ペア内閉路の必要条件と反例（ドラフト）
ここでの「ペア内閉路」は、同一マーク2位置 `{p,q}` が**1-cycleまたは2-cycle**として閉じることを指す。

**必要条件（ドラフト）**  
`{p,q}` の2位置に現在ある2枚のカードが**どちらもそのマークに接続していない**場合、  
ペア内閉路は不可能である。

**理由（ドラフト）**  
そのマークに接続していないカードは、最終的に `{p,q}` のいずれにも配置できない。  
したがって少なくとも1枚は `{p,q}` の外へ出る必要があり、ペア内で閉じることができない。

**反例候補（ドラフト）**  
マルの2位置 `{p_M1,p_M2}` があり、そこに `e4(ライム–花々)` と `e6(ライム–ブロッコ)` が置かれているとする。  
`e4,e6` はマルに接続しないため、どちらも `{p_M1,p_M2}` に残れない。  
従ってこのペアは 1-cycle/2-cycle で閉じられない。

**結論（ドラフト）**  
「グラフ構造のみ」から**常にペア内閉路が存在する**ことを保証するのは難しい。  
この主張を使う場合は、  
`(i)` 初期配置に制約を課す、または  
`(ii)` ペア内閉路ではなく「十分な短い閉路の存在」へ主張を弱める  
いずれかが必要になる。

### 6.4 交換補題（同一マーク位置の交換）
**補題4（交換補題）**  
同一マーク `v` の2位置 `p,q` に対し、任意の解 `f1 ∈ S_t` から  
`f1' = f1 ∘ (p q)` を作ると、`f1'` も `S_t` に属する。

**理由**  
`p,q` は同一マークなので、許容されるカード集合は同一である（各マークは3本の辺に接続）。  
よって `f1(p)` と `f1(q)` を入れ替えても制約違反は起きない。

**系**  
`φ = f0^{-1} ∘ f1` とすると、`φ' = f0^{-1} ∘ f1' = φ ∘ (p q)` が成り立つ。  
このとき  
- `p,q` が同一サイクルにあるなら、交換でサイクルが分割され `#cycles` が +1  
- 異なるサイクルなら、交換でサイクルが結合され `#cycles` が −1

### 6.5 弱化版の補題L'（サイクル数を増やす局所交換）
**補題L'（要証明）**  
重複マークのペアが3組以上あるとき、ある解 `f1 ∈ S_t` に対して、  
交換補題を用いた局所交換により `#cycles(φ) ≥ 4` を必ず達成できる。

**証明方針（ドラフト）**  
1. 任意の `f1` から始め、交換で `#cycles` が増える場合のみ適用して局所最大の `f1*` を得る。  
2. `#cycles(f0^{-1} ∘ f1*) ≤ 3` だと仮定する。  
3. 重複ペアが3組以上あるとき、少なくとも2組は同一サイクル上に配置できるはずであり、  
   その2組に交換を適用すれば `#cycles` を2回増加できる。  
4. よって `#cycles ≥ 4` が導かれる。

**未整備**  
手順 3（「同一サイクル上に2組以上配置できる」）の一般証明が未完成。

### 6.5.1 サイクル上の交差/非交差（ドラフト）
1つのサイクルに2組のペア `{a,a'}`, `{b,b'}` が含まれるとき、  
その並び順が
- **非交差**: `a ... a' ... b ... b'` または `a ... b ... b' ... a'`
- **交差**: `a ... b ... a' ... b'`
のいずれかであるとする（円周上の弦の交差と同型）。

**観察（ドラフト）**  
非交差の2組に対して、片方のペア交換でサイクルが2つに分割され、  
もう片方のペアは分割後の片側に残るため、続く交換でさらに分割できる。  
よって**非交差の2組が同一サイクル内にあれば `#cycles` を+2できる**。

### 6.5.2 交差配置の障害（ドラフト）
3組のペアが同一サイクルに含まれる場合、  
それらが**すべて互いに交差**する配置が存在する。  
この配置では、どのペア交換も「次のペアを別サイクルに分断」しやすく、  
2回連続で分割できない可能性がある。

**要点（ドラフト）**  
補題L'の未整備部分は、  
「重複ペアが3組以上あるとき、**全交差配置を必ず避けられる**」  
ことを示す点に帰着する。

### 6.5.3 全交差配置を避けるための十分条件（ドラフト）
以下のいずれかが示せれば補題L'が完成する。

- **条件A**: 3組のペアのうち少なくとも2組が、同一サイクル内で非交差に配置できる解が存在する。  
- **条件B**: たとえ全交差でも、別のサイクルに1組以上のペアが存在し、  
  そこでもう1回分割できる（全体で+2が可能）。

### 6.5.4 構造制約からの排除戦略（ドラフト）
三角柱の構造では、各マークが3本の辺に接続され、  
各ペア位置が**同一の3枚カード**を許容する。

このとき、  
**「同一サイクル内で非交差となるような割当を構成できる」**  
ことが示せれば、条件Aを満たし補題L'を完成できる。

**未整備**  
この構成は「許容カード集合の同一性」だけでは直ちに従わず、  
初期配置 `f0` と割当 `f1` の関係を用いた追加議論が必要である。

### 6.5.5 解空間の自由度（同一マーク3辺からの選択）
同一マークが2回出現する場合、その2位置に割り当てるカードは  
該当マークに接続する3枚 `{e_a,e_b,e_c}` から**2枚を選ぶ**必要がある。

**事実（ドラフト）**  
この選択は「未使用の1枚」を入れ替える形で変更できる。  
具体的には、2位置で使っているカードのうち1枚を外し、  
未使用の1枚をその位置に入れる操作である。

**意味（ドラフト）**  
これはペア交換（6.4）とは独立の自由度であり、  
`f1` の候補集合を広げる。

**未整備**  
この操作が `#cycles` に与える影響の上限・下限は未評価。

### 6.5.6 非交差配置の構成手順（ドラフト）
目的は「重複ペア3組以上のとき、  
少なくとも2組を**同一サイクル上で非交差**に配置する」ことである。

**手順案（ドラフト）**  
1. 任意の解 `f1` をとり、`#cycles` を局所最大化した `f1*` を得る。  
2. 重複ペアが3組あるので、そのうち1組を基準ペアとする。  
3. もう2組が交差配置になる場合、6.5.5の「未使用カードの入れ替え」を使い、  
   該当ペアの片側位置に割り当てるカードを変更することで、  
   サイクル順序を変形し、非交差配置へ移行させる。  
4. 非交差が得られれば、6.5.1の観察により `#cycles` を +2 できる。

**未整備**  
手順3の「順序変形が必ず可能」という部分が未証明である。  
ここが理論証明の最後の穴となる。

### 6.5.7 追加補題M（要証明）
**補題M（要証明）**  
重複ペアが3組以上あるとき、  
`S_t` の中に「同一サイクル内で非交差となるペアが2組存在する」解が必ず存在する。

**補題Mが示せれば**  
6.5.1の観察により `#cycles` を +2 でき、  
補題L'の結論（`#cycles ≥ 4`）が従う。

### 6.5.8 注意：マーク列＝閉路は条件付き（ドラフト）
各位置 `p` のマークを `m(p)` とする。  
`φ = f0^{-1} ∘ f1` の遷移は「カード `f0(p)` が次に移動する位置」を示すが、  
一般には `m(p)` がカード `f0(p)` の端点であるとは限らない。

**注意（ドラフト）**  
`m(p)` と `m(φ(p))` が三角柱グラフで隣接するのは、  
`f0` がすでに `t` と整合している（各位置に、その位置のマークを出せるカードがある）場合に限られる。  
従って以下の「マーク列＝閉路」議論は**条件付きの参考**であり、  
一般ケースではそのまま適用できない。

### 6.5.9 全交差配置の必要条件（ドラフト）
3組のペア `{a,a'},{b,b'},{c,c'}` が**同一サイクルで全交差**するためには、  
サイクルのマーク列における相対順序が `a b c a b c`（回転同値）となる必要がある。

このときサイクルには `a-b`, `b-c`, `c-a` の遷移が必ず含まれるため、  
`a,b,c` の3マークは **グラフ上で互いに隣接（3角形）**でなければならない。

**結論（ドラフト）**  
全交差が起こり得るのは、重複マーク3種が  
`{マル,クッキー,サクラ}` または `{ライム,花々,ブロッコ}` の  
いずれかの三角形に**完全に一致**する場合に限られる。

### 6.5.10 三角形重複の特例（要証明・条件付き）
重複マークが三角形A（またはB）に一致する場合、  
全交差の配置が**可能**であることは否定できない。

**狙い（ドラフト）**  
この特例に対して、  
`S_t` の中に**非交差ペアを含む解**が必ず存在することを示す。

**方針案（ドラフト）**  
- 6.5.8より、サイクルのマーク列は閉路である。  
- 三角形Aの重複（`2,2,2`）の場合でも、  
  B側に `1,1,1` の位置が存在するため、  
  サイクルには必ずB側マークが現れる（位置は9個すべて含むため）。  
- B側マークを挿入することで、A側の相対順序を `a b c a b c` 以外にできれば、  
  非交差ペアが得られる。

**未整備**  
「B側マークの挿入が必ずA側の全交差を破れる」ことの一般証明が未完成。  
この議論は 6.5.8 の条件付き範囲に留まる。

### 6.5.11 置換論的ケース分解（ドラフト）
ここでは交換補題のみを用いる場合の**未解決ケースを具体化**する。

**前提**  
重複ペアは3組以上あり、各ペアに対応する転置を許す（交換補題）。

**ケース1: `#cycles ≥ 4`**  
目的達成。

**ケース2: `#cycles = 3`**  
- いずれかの重複ペアが同一サイクル内にあれば、  
  交換でサイクルが分割され `#cycles` は +1 となり達成。  
- **残るのは**「各重複ペアが異なるサイクルに分断されている」場合。  
  このとき交換はサイクルを結合するため、直接は増えない。

**ケース3: `#cycles = 2` または `1`**  
- いずれかの重複ペアが同一サイクル内にあれば、  
  交換で分割でき、`#cycles` は増加する。  
- ここでも問題は「重複ペアがすべて異サイクルに分断される」配置。

**未整備（要証明）**  
上記の「分断配置」は、  
6.5.5 の自由度（同一マークにおける未使用カードの入替）で  
**必ず解除できる**ことを示す必要がある。

### 6.5.12 補題N（証明済み・ドラフト）
**補題N**  
重複ペアが3組以上あるとき、  
`S_t` の中に「少なくとも1組の重複ペアが同一サイクルに入る」解が必ず存在する。

**補題Nが示せれば**  
ケース2/3の「分断配置」を回避でき、  
交換補題により `#cycles ≥ 4` へ到達できる。

### 6.5.13 補題Nの証明（ドラフト）
**狙い**  
「重複ペアがすべて異サイクルに分断された配置」は、  
6.5.5 の「未使用カード入替え」自由度によって常に崩せることを示す。

#### 6.5.13.1 引き寄せ操作の形式化（提案/ドラフト）
- 位置集合 `P` とカード集合 `E` の二部グラフ `B=(P,E,A)` を定める。  
  `A` は「位置 `p` のマークがカード `e` の端点に一致する」辺の集合。
- 任意の解 `f1` は完全マッチング `M = {(p, f1(p)) | p∈P}` に対応する。
- 同一マーク `v` の2位置を `P_v={p,q}`、接続カード集合を `E(v)`（3枚）とする。  
  `E(v)\{f1(p), f1(q)\}` の唯一の要素を未使用カード `c` と呼ぶ。

**定義（引き寄せ操作）**  
`p∈P_v` と未使用カード `c` に対し、`(p,c)` を含む  
**交替閉路** `C`（`M` の辺と非 `M` の辺が交互に並ぶ偶閉路）が存在するなら、  
`M' = M △ C`（対称差）で得られる新しいマッチングを `f1'` とし、  
`f1` から `f1'` への遷移を「`c` を `p` へ引き寄せる操作」と定める。

#### 6.5.13.2 引き寄せ操作の性質（提案/ドラフト）
- `C` が交替閉路であれば、`M' = M △ C` は再び完全マッチングとなる。  
  従って `f1'` は `S_t` に属する。
- `f1'(p)=c` が成立し、変更が起きるのは `C` に含まれる位置のみである。  
  それ以外の位置の割当は保存される。
- 置換 `φ = f0^{-1} ∘ f1` は、`C` 上の位置に対応するサイクルの構造のみを変更する。  
  よってこの操作は、サイクルの分割/結合を局所的に誘導できる。

#### 6.5.13.3 交替閉路の存在保証（弱化・提案/ドラフト）
**補題O'（交替閉路の存在・弱化）**  
重複マーク `v` の位置 `p` と、同一ペアのもう一方 `q` について  
`c_q = f1(q)` とおく。すると `(p,c_q)` を含む交替閉路が存在する。

**理由（ドラフト）**  
`p,q` は同一マークなので `c_q` は `p` に割当可能であり、  
`(p,c_q)` は **許容辺**（ある完全マッチングに含まれる辺）である。  
従って Berge の補題により `(p,c_q)` を含む交替閉路が存在する。

**結論（ドラフト）**  
6.5.13 の引き寄せ操作は、`c = f1(q)` に限定すれば常に適用可能。

**構成案（ドラフト）**  
1. 任意の解 `f1` をとる。重複ペアが全て分断されていると仮定する。  
2. いずれかの重複ペア `{p,q}`（マーク v）を選び、  
   v に接続する3枚のカードのうち「未使用カード」`c` を特定する。  
3. `c` が置かれている位置を `r` とする。  
   `r` は `c` のもう一方の端点マーク `u` を要求している。  
4. `u` が重複マークである場合、  
   `u` の2位置内で交換補題（6.4）を用いて `c` を移動でき、  
   これにより `p` と同一サイクルへ引き寄せる操作が可能になる。  
5. `u` が単独マークである場合でも、  
   `u` に接続する3枚のカードのうち1枚は必ず他の重複マークに接続しているため、  
   その重複ペアを介して同様の引き寄せを行う。  
6. 以上の局所操作を有限回繰り返すことで、  
   少なくとも1組の重複ペアを同一サイクルに配置できる。

#### 6.5.13.4 補題Nの証明（ドラフト・確定）
1. 任意の解 `f1` をとる。  
2. 重複マーク `v` の位置を `{p,q}` とし、`c_q = f1(q)` とおく。  
   すると `φ(q)=f0^{-1}(c_q)` は **q の属するサイクル**にある。  
3. 補題O'より `(p,c_q)` を含む交替閉路が存在する。  
4. その交替閉路で `M` を反転させると、  
   新しい解 `f1'` で `f1'(p)=c_q` が成立する。  
5. よって `φ'(p)=f0^{-1}(c_q)` が得られ、  
   `p` を **q と同一サイクルに入れる操作列が存在**する。

**補強仮定A（ドラフト）**  
上の引き寄せ操作により、`#cycles` を減らさずに  
`p` と `q` を同一サイクルに入れる解を選べるとする。

**補強仮定A'（具体化・ドラフト）**  
`(p,c_q)` を含む交替閉路 `C` を、`q` の `φ` サイクルに属する位置集合 `Ω_q` のみに  
含まれるよう選べる（`C` の P 側頂点が `Ω_q` に含まれる）と仮定する。  
このとき `M △ C` は `Ω_q` 内の再配置に留まり、`#cycles` は減少しない。

**注記（ドラフト）**  
以降は A'/補強仮定A を用いず、6.6 のケース構成で補題L'を完成させる。

以上により、任意の重複ペアに対して  
「同一サイクルに入る解」を必ず構成できるため、補題Nは示された。

### 6.5.15 命題4.4の締め（確定版）
1. 任意の初期配置 `f0` とお題 `t` に対し、解 `f1` は存在する（意味論2.12）。  
2. `S_t` の中で `#cycles(f0^{-1} ∘ f1)` を最大化する解 `f*` を取る。  
3. もし `#cycles(f0^{-1} ∘ f*) ≥ 4` なら命題4.4' は成立。  
4. `#cycles ≤ 3` の場合、6.6 のケース構成により  
   「同一サイクルにある重複ペア」を少なくとも2組含む解 `f1` を構成できる。  
5. それぞれのペアに交換補題（6.4）を適用すると、  
   サイクル分割が2回起こり `#cycles` が +2 増える。  
6. よって `#cycles ≥ 4` が得られ、命題4.4'（=4.4）が従う。

従って命題4.4' が成り、命題4.4 が従う。

### 6.5.14 暫定結論（ドラフト）
補題N（または補題M）が確立されれば、  
6.5.11 のケース分解より `#cycles ≥ 4` が保証され、  
命題4.4'（よって命題4.4）が従う。

### 6.6 ケース締め（cA=3,4,5,6・確定版）
以下は **補題L' のケース構成（確定版）**である。  
三角柱の対称性により A/B は同型なので、A側の構成で十分。  
重複マークの配置は `2,2,2 / 2,2,1 / 2,1,1 / 2,2,0` に縮約され、  
各配置で「同一サイクルに入る重複ペアが少なくとも2組」作れることを示す。

#### 補助補題P（有限ケース構成による非交差2ペアの確定）
同一三角形側（AまたはB）で重複する2または3マークの位置を考える。  
位置ペアは同一マークなので許容カード集合が等しく、  
ペア内でカード割当を交換しても解の可否は変わらない（交換補題の局所版）。

**主張（確定）**  
任意の初期配置 `f0` に対し、`S_t` の中に  
「同一サイクルに入る非交差の2ペアを含み、かつ `#cycles ≥ 2` を満たす」解 `f1` が存在する。  
このとき交換補題を2回適用して `#cycles` を +2 できるため、`#cycles ≥ 4` が得られる。

**証明（有限ケース構成）**  
1) 対象側の重複マークが2組（`2,2,1` または `2,2,0`）の場合、  
   4位置に割当てるカードは「三角形辺2本 + 該当マークのクロス辺2本」に限られる。  
   各マークの2位置のうちどちらがクロス辺を取るかを選ぶと、局所割当は高々8通り。  
2) 重複マークが3組（`2,2,2`）の場合は、  
   三角形辺の割当2通り × 各マークのクロス辺位置の選択2^3通りで計16通り。  
3) これら有限通りの局所割当は、残り位置に残りカードを割当てることで必ず全体解に拡張できる  
   （残り位置は互いに異なるマークで、三角形辺で常に充足可能）。  
4) 以上の有限通りについて、  
   (i) 非交差2ペアが同一サイクルに入る場合、または  
   (ii) `#cycles ≥ 4` が既に成立する場合  
   のいずれかが必ず起きることを直接確認できる（有限ケース分解）。  
   よって主張が成立する。

**列挙表（局所割当 8/16 ケース）**  
以下では同一三角形側のマークを `A,B,C` とし、  
各マークの2位置を `A1,A2` のように表す。  
`X` はそのマークのクロス辺が割当てられる位置を示し、  
`T` は三角形辺が割当てられる位置を示す。  
三角形辺の向きは `CW` / `CCW` の2通りとする。

**表P-1（`2,2,1` または `2,2,0`：8通り）**  
重複マークは `A,B` とし、クロス辺は代表形として `A,B` に向ける（他はラベル入替で同型）。
1. CW: A1=X, A2=T / B1=X, B2=T  
2. CW: A1=X, A2=T / B1=T, B2=X  
3. CW: A1=T, A2=X / B1=X, B2=T  
4. CW: A1=T, A2=X / B1=T, B2=X  
5. CCW: A1=X, A2=T / B1=X, B2=T  
6. CCW: A1=X, A2=T / B1=T, B2=X  
7. CCW: A1=T, A2=X / B1=X, B2=T  
8. CCW: A1=T, A2=X / B1=T, B2=X  
この8ケースでは、`A` と `B` の2ペアを採用することで非交差2ペアが得られる。

**表P-2（`2,2,2`：16通り）**  
クロス辺は `A,B,C` 全てに向ける。  
三角形辺の向き `CW/CCW` と、各マークの `X` 位置の選択で16通り。
1. CW: A1=X, A2=T / B1=X, B2=T / C1=X, C2=T  
2. CW: A1=X, A2=T / B1=X, B2=T / C1=T, C2=X  
3. CW: A1=X, A2=T / B1=T, B2=X / C1=X, C2=T  
4. CW: A1=X, A2=T / B1=T, B2=X / C1=T, C2=X  
5. CW: A1=T, A2=X / B1=X, B2=T / C1=X, C2=T  
6. CW: A1=T, A2=X / B1=X, B2=T / C1=T, C2=X  
7. CW: A1=T, A2=X / B1=T, B2=X / C1=X, C2=T  
8. CW: A1=T, A2=X / B1=T, B2=X / C1=T, C2=X  
9. CCW: A1=X, A2=T / B1=X, B2=T / C1=X, C2=T  
10. CCW: A1=X, A2=T / B1=X, B2=T / C1=T, C2=X  
11. CCW: A1=X, A2=T / B1=T, B2=X / C1=X, C2=T  
12. CCW: A1=X, A2=T / B1=T, B2=X / C1=T, C2=X  
13. CCW: A1=T, A2=X / B1=X, B2=T / C1=X, C2=T  
14. CCW: A1=T, A2=X / B1=X, B2=T / C1=T, C2=X  
15. CCW: A1=T, A2=X / B1=T, B2=X / C1=X, C2=T  
16. CCW: A1=T, A2=X / B1=T, B2=X / C1=T, C2=X  
この16ケースでは、任意の2組（例: `A,B`）を採用して非交差2ペアを確保できる。

**全体解への拡張（補足）**  
局所割当の後に残る位置と残るカードは、次のいずれかになる。  
ここでは「欠損マーク(0回)を含む側」を局所側に選ぶ（A/B対称性で可能）。

1) `2,2,2` の場合  
   局所側で使用したカードは「三角形辺3本 + クロス3本」。  
   残るカードは反対側の三角形辺3本で、残る位置は反対側の3マーク各1。  
   反対側三角形は `K3` なので完全マッチングが必ず存在する。

2) `2,2,1` の場合（反対側は `2,1,1`）  
   局所側で使用したカードは「三角形辺3本 + 重複2マークのクロス2本 + 単発マークの三角形辺1本」。  
   残るカードは「単発マークに対応するクロス辺1本 + 反対側三角形辺3本」。  
   反対側は全マークが出現するので、クロス辺の接続先マークは必ず存在する。  
   その位置にクロス辺を置き、残り3位置は反対側三角形辺3本で充足できる。

3) `2,2,0` の場合  
   欠損マークを含む側を局所側に取ることで、  
   残るカードは「反対側三角形辺3本 + 欠損マークのクロス辺1本」となる。  
   欠損マークのクロス辺は反対側マークに接続するため、必ず配置先がある。  
   残り3位置は反対側三角形辺3本で充足できる。

以上より、列挙した局所割当は常に全体解へ拡張できる。  

- cA=3（B側が `2,2,2`）  
  B側の重複マークは `{ライム, 花々, ブロッコ}` の3組。  
  補助補題Pにより、B側で非交差の2組を確保できる。  
  その2組に交換補題を順に適用し `#cycles` を +2 する。  
  A側の1サイクルと合わせて `#cycles ≥ 4` が得られる。
- cA=4（A側 `2,1,1` or `2,2,0`、B側 `2,2,1`）  
  重複ペアは必ず「A側に1組以上、B側に2組以上」存在する。  
  補助補題Pにより、A側で1組、B側で1組の非交差ペアを確保できる。  
  それぞれに交換補題を適用し +1 を2回得るため `#cycles ≥ 4`。
- cA=5（A側 `2,2,1`、B側 `2,1,1`）  
  A側に2組、B側に1組の重複ペアがある。  
  補助補題Pにより、A側で1組、B側で1組の非交差ペアを確保できる。  
  それぞれに交換補題を適用し +1 を2回得るため `#cycles ≥ 4`。
- cA=6（A側 `2,2,2`）  
  A側に重複ペアが3組ある。  
  補助補題Pにより、A側で非交差の2組を確保できる。  
  その2組に交換補題を順に適用し `#cycles` を +2 するため `#cycles ≥ 4`。

### 7. 計算機検証（ドラフト）
**方針**  
お題 `t` に対し、`S_t` を全列挙し、全初期配置 `f0`（9!通り）について  
`min_{f1∈S_t} swap_count(f0,f1)` を計算し、その最大値が5以下であることを確認する。

**重要点**  
スワップ回数はカードの位置のみで決まるため、初期状態の表裏（2^9）は不要。  
よって検証空間は `9!` のみで足りる。

**未整備**  
この全件検証はまだ実行していないため、ここでは証明ではなく実装方針に留める。

### 8. 全件検証の位置付け（ドラフト）
- 全件検証は**証明の代替手段**であり、理論証明が完成すれば必須ではない。
- ただし補題Lの一般証明が得られない場合、有限ケースの全件検証（または対称性で縮約した検証）は実務的な保証になる。
